apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastapi-app
spec:
  replicas: 1  # Cambia para escalar
  selector:
    matchLabels:
      app: fastapi-app
  template:
    metadata:
      labels:
        app: fastapi-app
    spec:
      containers:
      - name: fastapi
        image: your-registry/fastapi-app:latest  # Cambia a tu imagen
        ports:
        - containerPort: 3000
        - containerPort: 3001
        - containerPort: 3002
        - containerPort: 3003
---
apiVersion: v1
kind: Service
metadata:
  name: fastapi-service
spec:
  selector:
    app: fastapi-app
  ports:
  - name: server1
    port: 3000
    targetPort: 3000
  - name: server2
    port: 3001
    targetPort: 3001
  - name: server3
    port: 3002
    targetPort: 3002
  - name: server4
    port: 3003
    targetPort: 3003
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-proxy
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx-proxy
  template:
    metadata:
      labels:
        app: nginx-proxy
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-config
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  selector:
    app: nginx-proxy
  ports:
  - port: 80
    targetPort: 80
  type: LoadBalancer  # O NodePort/Ingress seg√∫n necesidad
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
data:
  nginx.conf: |
    events {
        worker_connections 1024;
    }
    http {
        upstream server1 {
            server fastapi-service:3000;
        }
        upstream server2 {
            server fastapi-service:3001;
        }
        upstream server3 {
            server fastapi-service:3002;
        }
        upstream server4 {
            server fastapi-service:3003;
        }
        server {
            listen 80;
            location /api/server1/ {
                proxy_pass http://server1/;
            }
            location /api/server2/ {
                proxy_pass http://server2/;
            }
            location /api/server3/ {
                proxy_pass http://server3/;
            }
            location /api/server4/ {
                proxy_pass http://server4/;
            }
        }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rathole-client
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rathole-client
  template:
    metadata:
      labels:
        app: rathole-client
    spec:
      containers:
      - name: rathole
        image: rapiz1/rathole:latest
        volumeMounts:
        - name: rathole-config
          mountPath: /app/config.toml
          subPath: config.toml
        command: ["--config", "/app/config.toml", "--client"]
      volumes:
      - name: rathole-config
        configMap:
          name: rathole-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rathole-config
data:
  config.toml: |
    [client]
    remote_addr = "your-rathole-server.com:2333"
    [client.services.server1]
    type = "tcp"
    local_addr = "fastapi-service:3000"
    remote_addr = "0.0.0.0:3000"
    [client.services.server2]
    type = "tcp"
    local_addr = "fastapi-service:3001"
    remote_addr = "0.0.0.0:3001"
    [client.services.server3]
    type = "tcp"
    local_addr = "fastapi-service:3002"
    remote_addr = "0.0.0.0:3002"
    [client.services.server4]
    type = "tcp"
    local_addr = "fastapi-service:3003"
    remote_addr = "0.0.0.0:3003"